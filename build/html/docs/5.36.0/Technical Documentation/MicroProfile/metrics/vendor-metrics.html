<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Custom Vendor Metrics :: Payara Documentation Preview</title>
    <meta name="generator" content="Antora 2.2.0">
    <link rel="stylesheet" href="../../../../../_/css/site.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@alpha" />
    <meta name="docsearch:version" content="5.36.0" />
  </head>
  <body class="article">
  <header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../../..">Payara Documentation Preview</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-item hide-for-print">
        Version: <div class="page-versions">
  <button class="version-menu-toggle single-version" title="Current version">5.36.0</button>
</div>

      </div>
      <div class="navbar-item hide-for-print">
            <div id="search-input-container">
    </div>
      </div>

      <div class="navbar-end">
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="https://www.payara.fish/products/downloads/">Download</a>
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary enterprise" href="../../../../../../enterprise">Documentation for Payara Enterprise</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="docs" data-version="5.36.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-explore is-active" data-panel="explore">
  <div class="context">
    <span class="title">docs</span>
    <span class="version">5.36.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">docs</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../../index.html">5.36.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../Overview.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../../index.html">docs</a></li>
    <li><a href="vendor-metrics.html">Custom Vendor Metrics</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///home/alanroth/Workspace/Payara-Documentation/docs/modules/ROOT/pages/Technical%20Documentation/MicroProfile/metrics/vendor-metrics.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Custom Vendor Metrics</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a href="#documentation/user-guides/monitoring/mbeans.adoc" class="page unresolved">JMX MBeans</a> can be exposed as <strong><strong>Custom Vendor Metrics</strong></strong> by the user by supplying a custom <a href="https://github.com/payara/Payara/blob/master/appserver/payara-appserver-modules/microprofile/metrics/src/main/resources/metrics.xml">metrics.xml</a> file in the <code>${PAYARA_HOME}/glassfish/domains/${DOMAIN_NAME}/config/</code> folder with the following format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;config&gt;
    &lt;base&gt;
        ...
    &lt;/base&gt;
    &lt;vendor&gt;
        &lt;!--sample metadata--&gt;
        &lt;metadata&gt;
            &lt;!--tags are since 5.193 --&gt;
            &lt;tags&gt;
                &lt;tag&gt;
                    &lt;name&gt;operatingSystem&lt;/name&gt;
                    &lt;value&gt;Linux&lt;/value&gt;
                &lt;/tag&gt;
            &lt;/tags&gt;
            &lt;name&gt;system.cpu.load&lt;/name&gt;
            &lt;mbean&gt;java.lang:type=OperatingSystem/SystemCpuLoad&lt;/mbean&gt;
            &lt;type&gt;gauge&lt;/type&gt;
            &lt;unit&gt;none&lt;/unit&gt;
            &lt;displayName&gt;System CPU Load&lt;/displayName&gt;
            &lt;description&gt;Recent CPU usage for the whole system.&lt;/description&gt;
        &lt;/metadata&gt;
    &lt;/vendor&gt;
&lt;/config&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Payara Server has a more extensive range of MBeans available than Payara Micro, but these <em>AMX</em> MBeans need to be enabled through the <em>Monitoring</em> section of the admin console before they will be usable. Each of these AMX MBeans are also lazily loaded so, for example, JDBC connection pool MBeans will not be visible until an application that uses the connection pool is deployed.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="templating-metrics-amx-mbeans"><a class="anchor" href="#templating-metrics-amx-mbeans"></a>Templating Metrics for AMX MBeans</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is possible to create a template for a metric based on AMX MBeans properties for multiple resource configurations or similar objects (like JDBC connection pools for example).</p>
</div>
<div class="sect2">
<h3 id="simple-templating"><a class="anchor" href="#simple-templating"></a>Simple Templating</h3>
<div class="paragraph">
<p>You can use the <code>%s</code> placeholder to define a template in the metadata definition of the metric using the <code>mbean</code> element. The server will look for all MBeans that match the expression defined and will generate metrics for each one of them.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
You will need to use the <code>%s</code> placeholder in the name element as well to allow each metric to have a different name and avoid collisions.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="example"><a class="anchor" href="#example"></a>Example</h4>
<div class="paragraph">
<p>Here&#8217;s a simple example of defining a custom metric definition template that will generate metrics for the number of free connections available to all JDBC connections pools:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;metadata&gt;
     &lt;tags&gt;
        &lt;tag&gt;
            &lt;name&gt;name&lt;/name&gt;
            &lt;value&gt;%s&lt;/value&gt;
        &lt;/tag&gt;
     &lt;/tags&gt;
     &lt;name&gt;jdbc.connection.pool.numconnfree&lt;/name&gt;
     &lt;mbean&gt;amx:pp=/mon/server-mon[server],type=jdbc-connection-pool-mon,name=resources/%sPool/numconnfree#current&lt;/mbean&gt;
     &lt;type&gt;counter&lt;/type&gt;
     &lt;unit&gt;none&lt;/unit&gt;
     &lt;displayName&gt;numconnfreePool&lt;/displayName&gt;
     &lt;description&gt;The total number of free connections in the pool as of the last sampling.&lt;/description&gt;
&lt;/metadata&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which will yield the following results:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text"># TYPE vendor_jdbc_connection_pool_numconnfree_total counter
# HELP vendor_jdbc_connection_pool_numconnfree_total The total number of free connections in the pool as of the last sampling.
vendor_jdbc_connection_pool_numconnfree_total{name="resources/DerbyPool"} 0
vendor_jdbc_connection_pool_numconnfree_total{name="resources/H2Pool"} 0
vendor_jdbc_connection_pool_numconnfree_total{name="resources/__TimerPool"} 0 0</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="instance-names"><a class="anchor" href="#instance-names"></a>Instance Names</h4>
<div class="paragraph">
<p>Payara provides the placeholder <code>${instance}</code>. It is replaced with the name of the Payara instance, where the metrics is running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;metadata&gt;
    &lt;name&gt;requestcount.${instance}&lt;/name&gt;
    &lt;mbean&gt;amx:type=web-request-mon,pp=/mon/server-mon[${instance}],name=clusterjsp/server/requestcount#count&lt;/mbean&gt;
    &lt;type&gt;gauge&lt;/type&gt;
    &lt;unit&gt;none&lt;/unit&gt;
    &lt;displayName&gt;Request count for application&lt;/displayName&gt;
&lt;/metadata&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s the sample output of this metric being queried on a server instance named <code>i1</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">vendor_requestcount_i1 1</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="advanced-templating"><a class="anchor" href="#advanced-templating"></a>Advanced Templating</h3>
<div class="paragraph">
<p>If you need more control on the attributes of specific MBeans used in a metric definition, you can use the <code>${key}</code>, <code>${attribute}</code> and <code>${subattribute}</code> placeholders to define more fine-grained metrics.</p>
</div>
<div class="paragraph">
<p>These placeholders are used as follows:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>key</code></dt>
<dd>
<p>Used as a placeholder of the name (or part of the name) of an AMX MBean.</p>
</dd>
<dt class="hdlist1"><code>attribute</code></dt>
<dd>
<p>Used as a placeholder for the name of an <strong>attribute</strong> of an AMX MBean.</p>
</dd>
<dt class="hdlist1"><code>subattribute</code></dt>
<dd>
<p>Used as a placeholder for the name of a <strong>sub-attribute</strong> (or second-level attribute), which corresponds to the attribute of a <code>CompositeData</code> object.</p>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
You will need to use the <code>${key}</code>, <code>${attribute}</code> and <code>${subattribute}</code> placeholders in the <code>name</code> element as well to prevent name collisions between different templated metrics.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="example-1"><a class="anchor" href="#example-1"></a>Example</h4>
<div class="paragraph">
<p>Here&#8217;s an example of defining a custom metric definition template with these placeholders that will generate a counter metric for each specific connection metric that is available to all JDBC connection pools:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;metadata&gt;
     &lt;name&gt;jdbc.connection.pool.${key}Pool.${attribute}#${subattribute}&lt;/name&gt;
     &lt;mbean&gt;amx:pp=/mon/server-mon[server],type=jdbc-connection-pool-mon,name=resources/${key}Pool/${attribute}#${subattribute}&lt;/mbean&gt;
     &lt;type&gt;counter&lt;/type&gt;
     &lt;unit&gt;none&lt;/unit&gt;
&lt;/metadata&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which will yield the following results:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text"># TYPE vendor:jdbc_connection_pool_resources/_derby_pool_pool_numconnsuccessfullymatched#start_time counter
vendor:jdbc_connection_pool_resources/_derby_pool_pool_numconnsuccessfullymatched#start_time 1540463722554
# TYPE vendor:jdbc_connection_pool_resources/_derby_pool_pool_numconncreated#count counter
vendor:jdbc_connection_pool_resources/_derby_pool_pool_numconncreated#count 0
# TYPE vendor:jdbc_connection_pool_resources/_derby_pool_pool_connrequestwaittime#last_sample_time counter
vendor:jdbc_connection_pool_resources/_derby_pool_pool_connrequestwaittime#last_sample_time -1
# TYPE vendor:jdbc_connection_pool_resources/_derby_pool_pool_numconnused#start_time counter
vendor:jdbc_connection_pool_resources/_derby_pool_pool_numconnused#start_time 1540463106138
# TYPE vendor:jdbc_connection_pool_resources/_derby_pool_pool_numconnused#last_sample_time counter
vendor:jdbc_connection_pool_resources/_derby_pool_pool_numconnused#last_sample_time 1540463722554
# TYPE vendor:jdbc_connection_pool_resources/_derby_pool_pool_numconntimedout#start_time counter
vendor:jdbc_connection_pool_resources/_derby_pool_pool_numconntimedout#start_time 1540463722554
# TYPE vendor:jdbc_connection_pool_resources/_derby_pool_pool_connrequestwaittime#start_time counter
vendor:jdbc_connection_pool_resources/_derby_pool_pool_connrequestwaittime#start_time 1540463722554
# TYPE vendor:jdbc_connection_pool_resources/_derby_pool_pool_numconnfree#start_time counter
vendor:jdbc_connection_pool_resources/_derby_pool_pool_numconnfree#start_time 1540463106138
# TYPE vendor:jdbc_connection_pool_resources/_derby_pool_pool_numconnfailedvalidation#count counter
vendor:jdbc_connection_pool_resources/_derby_pool_pool_numconnfailedvalidation#count 0
......
# TYPE vendor:jdbc_connection_pool_resources/_h2_pool_pool_numconnsuccessfullymatched#start_time counter
vendor:jdbc_connection_pool_resources/_h2_pool_pool_numconnsuccessfullymatched#start_time 1540463722554
# TYPE vendor:jdbc_connection_pool_resources/_h2_pool_pool_numconncreated#count counter
vendor:jdbc_connection_pool_resources/_h2_pool_pool_numconncreated#count 0
......
......</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see_also"><a class="anchor" href="#_see_also"></a>See Also</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="#documentation/user-guides/monitoring/mbeans.adoc" class="page unresolved">JMX MBeans Reference</a></p>
</li>
</ul>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../../../_/js/site.js"></script>
<script async src="../../../../../_/js/vendor/highlight.js"></script>
<script async src="../../../../../_/js/vendor/docSearch.js"></script>
  </body>
</html>
