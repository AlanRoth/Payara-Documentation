<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Clustering :: Payara Documentation Preview</title>
    <meta name="generator" content="Antora 2.2.0">
    <link rel="stylesheet" href="../../../../../../_/css/site.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@alpha" />
    <meta name="docsearch:version" content="5.36.0" />
  </head>
  <body class="article">
  <header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../../../..">Payara Documentation Preview</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-item hide-for-print">
        Version: <div class="page-versions">
  <button class="version-menu-toggle single-version" title="Current version">5.36.0</button>
</div>

      </div>
      <div class="navbar-item hide-for-print">
            <div id="search-input-container">
    </div>
      </div>

      <div class="navbar-end">
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="https://www.payara.fish/products/downloads/">Download</a>
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary enterprise" href="../../../../../../../enterprise">Documentation for Payara Enterprise</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="docs" data-version="5.36.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-explore is-active" data-panel="explore">
  <div class="context">
    <span class="title">docs</span>
    <span class="version">5.36.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">docs</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../../../index.html">5.36.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../Overview.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../../../index.html">docs</a></li>
    <li><a href="Clustering.html">Clustering</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///home/alanroth/Workspace/ondro-poc/docs/modules/ROOT/pages/Technical%20Documentation/Payara%20Micro%20Documentation/Payara%20Micro%20Configuration%20and%20Management/Micro%20Management/Clustering.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Clustering</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>A Payara Micro cluster is based on Hazelcast, similarly to how Hazelcast clustering works in Payara Server. Each node in a Payara Micro cluster is effectively a Hazelcast node.</p>
</div>
<div class="paragraph">
<p>This makes it easy to dynamically scale infrastructure setup, without any complex configuration or downtime required.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lite-cluster-members"><a class="anchor" href="#lite-cluster-members"></a>Lite Cluster Members</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You may configure a Payara Micro instance as a Hazelcast <em>lite</em> node, meaning that the instance will join an existing cluster but will not store any data; like web session data or JCache data, for example.</p>
</div>
<div class="paragraph">
<p>To do this, use the <code>--lite</code> option when launching the instance through the command line.</p>
</div>
<div class="paragraph">
<p>You can create a cluster topology whereby a web application is hosted in a number of Payara Micro instances and the garbage collection ergonomics for these instances are tuned for throughput. In addition, a number of Payara Micro instances can be in the cluster with no applications deployed and these instances can be tuned for long-lived web session data. In this case, the web application instances could be designated as lite cluster members to make sure no web session data is stored within their JVMs.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Lite members can also be used purely if you want a clustered Payara Micro instance to join the same cluster and receive CDI events or clustered events, but without storing any data.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="automatic-clustering"><a class="anchor" href="#automatic-clustering"></a>Automatic Clustering</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Payara Micro has the ability to auto-cluster, since by default it uses the <a href="#multicast-discovery">Multicast discovery mode</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="discovery-modes"><a class="anchor" href="#discovery-modes"></a>Discovery Modes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Like in Payara Server, the following discovery modes are supported in Payara Micro:</p>
</div>
<div class="sect2">
<h3 id="multicast-discovery"><a class="anchor" href="#multicast-discovery"></a>Multicast Discovery Mode</h3>
<div class="paragraph">
<p>The integration of Hazelcast into Payara Micro allows instances to automatically and dynamically cluster together when two instances or more instances are pointed at the same multicast address and port.</p>
</div>
<div class="sect3">
<h4 id="multicast-example"><a class="anchor" href="#multicast-example"></a>Example</h4>
<div class="paragraph">
<p>Start two Payara Micro instances (with different HTTP port configurations or use <code>--autobindhttp</code>), and you should see the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-log hljs" data-lang="log">Members [2] {
Member [192.168.174.130]:5900 this
Member [192.168.174.130]:5901</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The <code>--startPort</code> option is used to determine which clustering port the Payara Micro instance will <strong>first</strong> try to bind to. If the port is already bound to then the Payara Micro instance will simply increment the <em>startPort</em> value and try again until it finds a port it can bind to.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="preventing-cluster-cross-talk"><a class="anchor" href="#preventing-cluster-cross-talk"></a>Preventing Multicast Cluster Cross Talk</h4>
<div class="paragraph">
<p>By default Payara Micro clusters automatically discover other cluster members via multicast. This can lead to the situation whereby different development environments that are used by different teams may unintentionally cluster together as they are using the same multicast address and multicast port.</p>
</div>
<div class="paragraph">
<p>If you wish to separate multiple clusters, then you can use the <code>--mcAddress</code> and <code>`--mcPort</code> options to define a different multicast address and port; assign a different address and port to each set of instances you wish
to run in a separate cluster and they will automatically make their own cluster on the new multicast address and port.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can also use <code>--clusterName</code> and <code>--clusterPassword</code> to separate clusters. If all other multicast settings are similar, instances will only cluster together if all the instances have the same cluster name and cluster password.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="domain-discovery"><a class="anchor" href="#domain-discovery"></a>Domain Discovery Mode</h3>
<div class="paragraph">
<p>Domain Discovery Mode enables a Payara Micro instance to join an existing Domain Data Grid managed by a Payara Server DAS. To join a Domain Data Grid start the Micro instance in domain cluster mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">java -jar payara-micro.jar --clustermode domain:192.168.0.64:4900</code></pre>
</div>
</div>
<div class="paragraph">
<p>The format of the domain cluster mode is <code>domain:ip:port</code> where <code>ip</code> is the IP network address that the Hazelcast instance is bound to in the DAS.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Hazelcast is very particular about the IP address used to join a cluster. The IP Address should be exactly as reported by the details
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When the DAS starts it will log output similar to this one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-log hljs" data-lang="log">Data Grid Status
Payara Data Grid State: DG Version: 35 DG Size: 2
Instances: {
Address: /192.168.0.104:4900 UUID: 7c1bd6ca-1574-4e38-9189-effcd4ccafd2 Lite: false This: true Name: server Group: server-config
Address: /192.168.0.104:5900 UUID: 0f6887b2-9932-4085-a6f8-e40751269023 Lite: false This: false
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This shows the IP address and ports that can be used as input into the domain cluster mode.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you accidentally choose the DAS admin port (by default <code>4848</code>) as the cluster port you will get a warning like the following:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-log hljs" data-lang="log">[2018-03-08T13:51:46.446+0000] [] [WARNING] [] [fish.payara.nucleus.hazelcast.DomainDiscoveryService] [tid: _ThreadID=1 _ThreadName=main] [timeMillis: 1520517106446] [levelValue: 900] You have specified 4848 as the datagrid domain port however this is the default DAS admin port, the default domain datagrid port is 4900</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tcpip-discovery"><a class="anchor" href="#tcpip-discovery"></a>TCPIP Discovery Mode</h3>
<div class="paragraph">
<p>The TCPIP Discovery Mode can be used to cluster Payara Micro Community instances when multicast is not available on the network. This is especially useful in Cloud environments or in containerized deployments like Docker and Kubernetes. For the TCPIP discovery mode you specify a comma separated list of <code>ip:port</code> addresses where you believe other instances will be listening.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Hazelcast is very particular about the IP address used to join a cluster. The IP Address should be exactly as reported by the details
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example the following command will cluster two Payara Micros together when multicast is not available:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">java -jar payara-micro.jar --autobindhttp --clustermode tcpip:192.168.0.104:6900,192.168.0.104:6901
java -jar payara-micro.jar --autobindhttp --clustermode tcpip:192.168.0.104:6900,192.168.0.104:6901</code></pre>
</div>
</div>
<div class="paragraph">
<p>A range of IP addresses can be specified in the list of members for example: <code>192.168.1.0-7:6900</code>. This is especially useful if you have a cloud VPC and you have a number of Payara Micro instances running across a number of Cloud VMs. Using a range is also useful in Docker environments where the range of IP Addresses is known but dynamic for example <code>172.17.0.2-8:6900</code>.</p>
</div>
<div class="paragraph">
<p>During discovery Payara Micro will test each <code>IP:Port</code> combination until it finds another Payara Micro instance. As long as one instance exists then it will join the existing cluster. If no Payara Micro instances are contactable the instance will create a new cluster with itself as the single member.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
TCPIP cluster mode can also be used to join an existing Payara Server Domain Data Grid by specifying the <code>ip:port</code> of the DAS Hazelcast&#8217;s instance.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="dns-discovery-mode"><a class="anchor" href="#dns-discovery-mode"></a>DNS Discovery Mode</h3>
<div class="paragraph">
<p>The DNS Discovery mode can be used to cluster Payara Micro instances by specifying a DNS name. Similar to the TCPIP discovery mode, this discovery mode takes a comma separated list of DNS <strong>A</strong>/<strong>AAAA</strong> record names and ports to determine where to look for instances to cluster with, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">java -jar payara-micro.jar --autobindhttp --clustermode dns:localhost:6900,ubuntu:6900,suse:6900</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If there are multiple IP addresses associated with a DNS name, Payara Micro will attempt to cluster with all of them.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="kubernetes-discovery"><a class="anchor" href="#kubernetes-discovery"></a>Kubernetes Discovery Mode</h3>
<div class="paragraph">
<p>The Kubernetes discovery mode can be used to cluster Payara Micro instances running in a Kubernetes cluster,
which can be useful due to the variable networking inherent to the technology. When using this discovery mode, the default
settings will make Payara Micro attempt to cluster with instances present on Pods within the default namespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">java -jar payara-micro.jar --autobindhttp --clustermode kubernetes</code></pre>
</div>
</div>
<div class="paragraph">
<p>Optionally, you can provide a Kubernetes namespace and service name separated by a comma. Payara Micro will then
attempt to cluster with instances present on pods within the specified namespace and service. If using the latter
option, you must provide BOTH a namespace and service name, as these options cannot be used individually.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">java -jar payara-micro.jar --autobindhttp --clustermode kubernetes:default,service1</code></pre>
</div>
</div>
<div class="paragraph">
<p>This discovery mode internally uses the Hazelcast Kubernetes plugin, and so you will need to grant specific permissions to query the Kubernetes master node. As per the plugin documentation, you will need to apply the following permissions using the <code>kubectl apply</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: default-cluster
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: view
subjects:
- kind: ServiceAccount
  name: default
  namespace: default</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="network-interfaces"><a class="anchor" href="#network-interfaces"></a>Network Interfaces</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If Hazelcast chooses the incorrect IP Address to bind to (for example a docker interface) the <code>--interfaces</code> command line option can be used to force Hazelcast to use the specified network interface and prevent second-guesses:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">java -jar payara-micro.jar --autobindhttp --clustermode tcpip:192.168.0.104:6900,192.168.0.104:6901 --interfaces 192.168.0.104</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="see-also"><a class="anchor" href="#see-also"></a>See Also</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/hazelcast/hazelcast-kubernetes#grating-permissions-to-use-kubernetes-api">Grating Permissions To Use Kubernetes API</a></p>
</li>
<li>
<p><a href="https://github.com/helm/charts/tree/master/stable/hazelcast#configuration">Hazelcast Configuration</a></p>
</li>
</ul>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../../../../_/js/site.js"></script>
<script async src="../../../../../../_/js/vendor/highlight.js"></script>
<script async src="../../../../../../_/js/vendor/docSearch.js"></script>
  </body>
</html>
