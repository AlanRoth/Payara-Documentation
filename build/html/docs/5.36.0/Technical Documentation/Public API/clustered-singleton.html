<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Clustered Singleton :: Payara Documentation Preview</title>
    <meta name="generator" content="Antora 2.2.0">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@alpha" />
    <meta name="docsearch:version" content="5.36.0" />
  </head>
  <body class="article">
  <header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../..">Payara Documentation Preview</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-item hide-for-print">
        Version: <div class="page-versions">
  <button class="version-menu-toggle single-version" title="Current version">5.36.0</button>
</div>

      </div>
      <div class="navbar-item hide-for-print">
            <div id="search-input-container">
    </div>
      </div>

      <div class="navbar-end">
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="https://www.payara.fish/products/downloads/">Download</a>
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary enterprise" href="../../../../../enterprise">Documentation for Payara Enterprise</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="docs" data-version="5.36.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-explore is-active" data-panel="explore">
  <div class="context">
    <span class="title">docs</span>
    <span class="version">5.36.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">docs</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../index.html">5.36.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../Overview.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">docs</a></li>
    <li><a href="clustered-singleton.html">Clustered Singleton</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///home/alanroth/Workspace/ondro-poc/docs/modules/ROOT/pages/Technical%20Documentation/Public%20API/clustered-singleton.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Clustered Singleton</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>Since versions 4.1.2.182 and 5.181</em></p>
</div>
<div class="paragraph">
<p>The Payara API provides a <code>@Clustered</code> annotation that makes
<code>@ApplicationScoped</code> CDI beans or <code>@Singleton</code> EJB beans cluster-wide. This
allows a single bean to be shared across an entire cluster.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="howitworks"><a class="anchor" href="#howitworks"></a>How It Works</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The singleton bean is deployed and will be available to all members of the cluster.
Prior to any call to this bean, its latest version will be retrieved from a Hazelcast map,
which will be possibly updated after the call is finished. In order to avoid race conditions or data corruption,
a <strong>Hazelcast distributed lock</strong> for the bean will be optionally acquired so that only
one method call can be executed in the cluster at a time.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Examples can be found here: <a href="https://github.com/payara/Payara-Examples/tree/master/javaee/clustered-singleton" class="bare">https://github.com/payara/Payara-Examples/tree/master/javaee/clustered-singleton</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="timers"><a class="anchor" href="#timers"></a><code>@Clustered</code> and EJB Timers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Persistent EJB Timers (which are the default) will work correctly with clustered singletons since they will only be executed in a single node of the cluster</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="initialization"><a class="anchor" href="#initialization"></a><code>@Clustered</code> and <code>@Startup</code> / <code>@Initialized</code> <code>@ApplicationScoped</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Care must be taken in this scenario. By default, <code>@PostConsctuct</code> is called for every instance in the cluster for these beans. This behavior needs to be disabled by using <code>@Clustered(callPostConstructOnAttach = false)</code> and possibly <code>callPreDestoyOnDetach = false</code> as well, so only the <code>@PostConstcut</code> method will be called only once per cluster.
<code>@Observed</code> <code>@Initialzed</code> methods are called for every instance in the cluster. The only valid method for cluster-wide initialization is @PostConstruct method configured as described above.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cdinotes"><a class="anchor" href="#cdinotes"></a>CDI Considerations and Notes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since there are no default locks for CDI, <code>@Clustered</code> CDI <code>@ApplicationScoped</code> beans do not have distributed locks on by default.
It is highly recommended to enable distributed locks for CDI Clustered beans: <code>@Clustered(lock = DistributedLockType.LOCK)</code> so there is no chance of race condition / data corruption for CDI Clustered beans</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="requirementss"><a class="anchor" href="#requirementss"></a>Requirements and assumption</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Hazelcast is required to be enabled (default on Payara 5)</p>
</li>
<li>
<p><code>@Clustered</code> only works with <code>@ApplicationScoped</code> or <code>@Singleton</code> annotation, and in no other circumstance</p>
</li>
<li>
<p>All fields in the <code>@Clustered @Singleton</code> class need to be correctly Serializable</p>
</li>
<li>
<p>Works correctly only if accessed via @Injected proxy, not through direct access</p>
</li>
<li>
<p>Works with EJB timers correctly only if all timers are persistent (default)</p>
</li>
<li>
<p>All method calls to <code>@Clustered</code> beans operate on a local instance</p>
</li>
<li>
<p>Data corruption is possible if distributed lock is turned off and there is a race condition between method calls to the same bean on multiple cluster nodes simultaneously. In such a case, last method call wins the singleton state</p>
</li>
<li>
<p>Clustered singletons are stored in Hazelcast map under "Payara/(EJB/CDI)/singleton/&lt;singletonComponentName&gt;/[lock]"</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="usage"><a class="anchor" href="#usage"></a>Usage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A singleton bean is made cluster-wide by annotating the class
with the <code>@fish.payara.cluster.Clustered</code> qualifier as well as
it&#8217;s scope annotation.</p>
</div>
<div class="paragraph">
<p>Alternatively, you can use the <code>glassfish-ejb-jar.xml</code> to configure a Singleton EJB
to be cluster-wide.</p>
</div>
<div class="sect2">
<h3 id="usage-example"><a class="anchor" href="#usage-example"></a>Example</h3>
<div class="paragraph">
<p>An example for a CDI bean:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Clustered
@javax.enterprise.context.ApplicationScoped
public class ClusterSingletonBean implements Serializable {

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>An example for a Singleton EJB:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Clustered
@javax.ejb.Singleton
public class ClusterSingletonBean implements Serializable {

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>An example for a Singleton EJB using <code>glassfish-ejb.jar</code> (<code>clustered-key-name</code> is optional):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;glassfish-ejb-jar&gt;
    &lt;enterprise-beans&gt;
        &lt;ejb&gt;
            &lt;ejb-name&gt;ClusteredSingleton&lt;/ejb-name&gt;
            &lt;clustered-bean&gt;true&lt;/clustered-bean&gt;
            &lt;clustered-key-name&gt;ClusteredSingleton&lt;/clustered-key-name&gt;
        &lt;/ejb&gt;
    &lt;/enterprise-beans&gt;
&lt;/glassfish-ejb-jar&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration"><a class="anchor" href="#configuration"></a>Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>@Clustered</code> annotation has several configuration options. They are detailed below.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Configuration Options</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">XML element</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">keyName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">clustered-key-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The key in the distributed map to bind the clustered object to.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the bean. If the bean is a CDI bean and has no assigned name,
the bean class name will be used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lock</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">clustered-lock-type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The type of distributed locking to be performed.
For EJB beans, only <code>INHERIT</code> and <code>LOCK_NONE</code> are valid.
For CDI beans, valid values are <code>LOCK</code> and <code>INHERIT</code>, which
is equivalent to using <code>LOCK_NONE</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>INHERIT</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">callPostConstructOnAttach</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">clustered-attach-postconstruct</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to call <code>@PostConstruct</code> each time the bean is created
on a different node. Will result in multiple calls.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">callPreDestroyOnDetach</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">clustered-detach-predestroy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to call <code>@PreDestroy</code> when the singleton is destroyed on an
instance while still being available on another. Will result in
multiple calls.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="locking"><a class="anchor" href="#locking"></a>Distributed Locking</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Clustered singleton beans allow a locking type, to specify how the
distributed object is locked when being accessed by multiple instances.
The lock options are members of the class
<code>fish.payara.cluster.DistributedLockType</code>, which are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>LOCK</code> - Distributed locking will be performed.</p>
</li>
<li>
<p><code>LOCK_NONE</code> - No distributed locking will be performed.</p>
</li>
<li>
<p><code>INHERIT</code> - The locking behaviour will be inherited from
the inherited class.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By default, <code>@Singleton</code> EJBs will use a distributed lock, and
<code>@ApplicationScoped</code> CDI beans won&#8217;t.</p>
</div>
<div class="paragraph">
<p>When a distributed object is locked, it will only be written
by one thread across the entire cluster at any one time. Locks use system
resources, but prevent synchronisation errors with the singleton data.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If a member holding a lock goes offline, the lock will become
available again.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="transactions"><a class="anchor" href="#transactions"></a>Transactions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Transactions in a clustered singleton work the same way that they would work
in EJB or CDI depending on which scope annotation you&#8217;re using. Transactions
are not distributed through the whole cluster. When a transaction is created
in a thread in one JVM, it must be handled and closed in the same thread;
it cannot be passed onto a different server instance. Once the transaction
is closed, the changes will be replicated to the rest of the cluster.</p>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script async src="../../../../_/js/vendor/docSearch.js"></script>
  </body>
</html>
