<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OpenID Connect Support :: Payara Documentation Preview</title>
    <meta name="generator" content="Antora 2.2.0">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@alpha" />
    <meta name="docsearch:version" content="5.36.0" />
  </head>
  <body class="article">
  <header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../..">Payara Documentation Preview</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-item hide-for-print">
        Version: <div class="page-versions">
  <button class="version-menu-toggle single-version" title="Current version">5.36.0</button>
</div>

      </div>
      <div class="navbar-item hide-for-print">
            <div id="search-input-container">
    </div>
      </div>

      <div class="navbar-end">
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="https://www.payara.fish/products/downloads/">Download</a>
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary enterprise" href="../../../../../enterprise">Documentation for Payara Enterprise</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="docs" data-version="5.36.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-explore is-active" data-panel="explore">
  <div class="context">
    <span class="title">docs</span>
    <span class="version">5.36.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">docs</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../index.html">5.36.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../Overview.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">docs</a></li>
    <li><a href="openid-connect-support.html">OpenID Connect Support</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///home/alanroth/Workspace/ondro-poc/docs/modules/ROOT/pages/Technical%20Documentation/Public%20API/openid-connect-support.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">OpenID Connect Support</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The Payara API provides a <code>@OpenIdAuthenticationDefinition</code> annotation that creates an authorization mechanism for OpenID Connect support. This works in the same way as other authorization mechanisms in the Java EE Security API.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="usage"><a class="anchor" href="#usage"></a>Usage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The OpenID Connect authentication mechanism is defined through the <code>@OpenIdAuthenticationDefinition</code> annotation. Specifying this in a valid place as defined by the Java EE Security API will create the mechanism.</p>
</div>
<div class="sect2">
<h3 id="usage-example"><a class="anchor" href="#usage-example"></a>Example</h3>
<div class="paragraph">
<p>Here&#8217;s an example that configures a OpenID Connect client:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@OpenIdAuthenticationDefinition(
       providerURI = "https://sample-openid-server.com",
       clientId = "87068hgfg5675htfv6mrucov57bknst.apps.sample.com",
       clientSecret = "{my-secret}",
       redirectURI = "${baseURL}/callback",
       extraParameters = {
            "testKey=testValue",
            "testKey2=testValue2"
       }
)
public class SecurityBean {

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="https://github.com/javaee-samples/vendoree-samples/tree/master/payara/openid">this sample project</a> for a more detailed example.</p>
</div>
<div class="paragraph">
<p>When defining a OpenID Connect flow within an application deployed on Payara Server, it is possible to retrieve the access token, identity token, user claims and the other authentication information within any bean in the scope of the callback/redirectURI resource used to configure the authentication:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@WebServlet("/callback")
public class CallbackServlet extends HttpServlet {

    @Inject
    OpenIdContext context;

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        PrintWriter out = response.getWriter();
        //Here's the caller name
        out.println(context.getCallerName());
        //Here's the caller groups
        out.println(context.getCallerGroups());
        //Here's the unique subject identifier within the issuer
        out.println(context.getSubject());
        //Here's the access token
        out.println(context.getAccessToken());
        //Here's the identity token
        out.println(context.getIdentityToken());
        //Here's the user claims
        out.println(context.getClaimsJson());
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The original protected URL called is stored so that a redirect can be issued to this page after the callback from the OpenIdConnect provider is handled.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Only some basic redirect is supported namely a GET. Only the URL and query parameters are available, not the headers and the request body.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        // handling the OpenIdContext information. See previous example
        // Now return to original requested page
        response.sendRedirect(request.getSession().getAttribute(OpenIdConstant.ORIGINAL_REQUEST).toString());
    }</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration"><a class="anchor" href="#configuration"></a>Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>OpenID Client can be configured with both <code>@OpenIdAuthenticationDefinition</code> annotation attributes and Microprofile Config properties.
The annotation and MicroProfile properties has several configuration options.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
If you are using MicroProfile Config properties and the value contains a placeholder that should not be resolved by MicroProfile Config
itself but by the Server (like <code>payara.security.openid.redirectURI=${baseURL}/Callback</code>) make sure the value is properly escaped. It will otherwise result in <code>NoSuchElementException</code>. Here&#8217;s an example how such a value should be escaped: <code>payara.security.openid.redirectURI=\\${baseURL}/Callback</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The annotation and MicroProfile properties has several configuration options. They are detailed below.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Configuration Options for `@OpenIdAuthenticationDefinition</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">MP Config property</th>
<th class="tableblock halign-left valign-top">Required/Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Requirements</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>providerURI</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.providerURI</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The provider URI to discover the metadata of the OpenID Connect provider. If not specified, metadata are read from <code>providerMetadata</code>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The endpoint must be HTTPS.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>providerMetadata</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">required if <code>providerURI</code> not specified, type: <code>@OpenIdProviderMetadata</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Alternative way to specify metadata if auto-configuration from <code>providerURI</code> can&#8217;t be used.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.provider.*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The endpoint must be HTTPS.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>clientId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.clientId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The client identifier issued when the application was registered.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>clientSecret</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.clientSecret</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The client secret for the registered application.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>redirectURI</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.redirectURI</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The URL to redirect the user to upon successful authentication. Can include the variable ${baseURL}, which is replaced by the URL of the application&#8217;s context path (e.g. <code><a href="https://myhost:8080/myapp" class="bare">https://myhost:8080/myapp</a></code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">${baseURL}/Callback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Must be equal to one set in the OpenID Connect provider.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>scope</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.scope</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The scopes requested from the OpenID Connect provider.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{"openid", "email", "profile"}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>responseType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.responseType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response Type value defines the processing flow to be used.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">code</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>responseMode</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.responseMode</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Informs the Authorization Server of the mechanism to be used for returning parameters from the Authorization Endpoint.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>prompt</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.prompt</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The prompt value specifies whether the authorization server prompts the user for re-authentication and consent.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>display</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.display</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The display value specifying how the authorization server displays the authentication and consent user interface pages.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">page</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>useNonce</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.useNonce</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables string value used to mitigate replay attacks.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>useSession</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.useSession</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If enabled state &amp; nonce value stored in session otherwise in cookies.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jwksConnectTimeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.jwks.connect.timeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the connect timeout(in milliseconds) for Remote JWKS retrieval.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>500</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value must not be negative and if value is zero then infinite timeout.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jwksReadTimeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.jwks.read.timeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the read timeout(in milliseconds) for Remote JWKS retrieval.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">500</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value must not be negative and if value is zero then infinite timeout.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tokenAutoRefresh</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.token.autoRefresh</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables or disables the automatically performed refresh of Access and Refresh Token.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tokenMinValidity</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.token.minValidity</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the minimum validity time(in milliseconds) the Access Token must be valid before it is considered expired.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value must not be negative.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>claimsDefinition.callerNameClaim</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.callerNameClaim</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the name of callerName claim and maps the claim&#8217;s value to caller name value in IdentityStore#validate.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">preferred_username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>claimsDefinition.callerGroupsClaim</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.callerGroupsClaim</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the name of callerGroups claim and maps the claim&#8217;s value to caller groups value in IdentityStore#validate.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">groups</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>extraParameters</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An array of extra options to be sent to the OpenID Connect provider.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Must be in the form <code>key=value</code> and follow URL query pattern, i.e. <code>key1=value1&amp;key2=value2&amp;key2=value+with+spaces</code>. Key entries can be repeated</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>logout</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">@LogoutDefinition</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the functionality that is performed when the user logs out and defines the RP Session Management configuration.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If both an annotation attribute and a MicroProfile Config property are defined for the same option
then the MicroProfile Config property value always takes precedence over the <code>@OpenIdAuthenticationDefinition</code> annotation value.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Configuration Options For <code>@OpenIdProviderMetadata</code></caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">MP Config property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>endSessionEndpoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.provider.endSessionEndpoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OIDC provider’s logout endpoint URL. If set, overrides the URL obtained via the <code>end_session_endpoint</code> element of the OIDC provider’s metadata.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>disableScopeValidation</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.disableScopeValidation</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This property disables the scope validation for custom scope configurations</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="el-support"><a class="anchor" href="#el-support"></a>Expression Language Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>@OpenIdAuthenticationDefinition</code> supports the use of expression language (EL) notation for programmatic configuration scenarios. This means that you can use any CDI bean properties to set the OpenID Connect configuration like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@OpenIdAuthenticationDefinition(
    providerURI="#{openidConfigBean.tokenEndpointURL}",
    clientId="#{openidConfigBean.clientId}",
    clientSecret="#{openidConfigBean.clientSecret}",
    redirectURI="#{openidConfigBean.redirectURI}"
)
public class SecurityBean {
}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
By default, the EL expressions are evaluated only once after the application is loaded and the evaluated values are then remembered until the application is reloaded, for performance reasons. This means that although the configuration can be evaluated dynamically the first time it&#8217;s needed, it&#8217;s not possible to change the configuration later on. If you need to dynamically modify the configuration during the lifetime of the application, follow the next section about multitenancy support.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="multitenancy"><a class="anchor" href="#multitenancy"></a>Multitenancy Support (Session-scoped Configuration)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default, the same configuration of the OpenID connector is applied for the whole application, for all authentication attempts. This is for performance reasons. The OpenID connector also supports re-evaluating the configuration for each user session, before each authentication attempt. This is useful in a multitenant scenario to define a different configuration for each tenant. It&#8217;s also useful if the user should be able to select which provider they want to use to authenticate.</p>
</div>
<div class="paragraph">
<p>To enable re-evaluation of the configuration for each user session, set the MicroProfile Configuration property <code>payara.security.openid.sessionScopedConfiguration</code> to <code>true</code>. To specify it directly in the application, you can place it in the <a href="https://download.eclipse.org/microprofile/microprofile-config-1.4/microprofile-config-spec.html#default_configsources">microprofile-config.properties</a> file in the <code>META-INF</code> directory on the classpath (in a WAR application it could be in <code>WEB-INF/classes/META-INF</code>).</p>
</div>
<div class="paragraph">
<p>With this enabled, it&#8217;s possible to use EL expressions to dynamically adjust the configuration before each authentication attempt, e.g. based on any information in the incoming HTTP request. The information about the HTTP request can be retrieved from a <code>HttpServletRequest</code> object injected using <code>@Inject</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
It&#8217;s not possible to use a different configuration for just a subset of secured resources. Once a user is authenticated, the authentication information is saved in the HTTP session. All secured resources will be accessed using the same user, having the same roles, until the user logs out.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="example-multitenant"><a class="anchor" href="#example-multitenant"></a>Example Multitenant Authentication</h3>
<div class="paragraph">
<p>This example should showcase the following steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enable session-scoped OpenID Connect configuration</p>
</li>
<li>
<p>Resolve the tenant name from an HTTP request query parameter</p>
</li>
<li>
<p>Use the tenant name to read the configuration value from the respective <a href="#documentation/microprofile/config/README.adoc" class="page unresolved">MicroProfile Config</a> property</p>
</li>
<li>
<p>Retrieve the value from an EL expression defined in the <code>@OpenIdAuthenticationDefinition</code> annotation</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The tenant can also be resolved from a cookie, which is set the first time a user loads the application; from the domain name in the URL (if different tenants use a different domain name to access the same application); from a path prefix that follows the context root and prepends all application URLs (e.g. <code>contextroot/tenant1/index.xhtml</code>, <code>contextroot/tenant2/index.xhtml</code>).
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a file <code>microprofile-config.properties</code> in your application (for a WAR application it would be in the <code>WEB-INF/classes/META-INF</code> directory), with the following contents:</p>
<div class="listingblock">
<div class="title">microprofile-config.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">payara.security.openid.tenant1.providerURI=&lt;TENANT1_OPENID_PROVIDER_URI&gt;
payara.security.openid.tenant2.providerURI=&lt;TENANT2_OPENID_PROVIDER_URI&gt;
payara.security.openid.sessionScopedConfiguration=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will provide configuration for <code>tenant1</code> and <code>tenant2</code> tenants. For each additional tenant, add a new line for its <code>providerURI</code>.</p>
</div>
</li>
<li>
<p>Create an <code>OpenidConfigBean</code> class with the <code>tokenEndpointURL</code> method. This class will be a CDI bean that injects <code>HttpServletRequest</code> to get information about which tenant to use. It will also inject <code>Config</code> to retrieve the configuration about each tenant from the <code>microprofile-config.properties</code> file:</p>
<div class="listingblock">
<div class="title">OpenidConfigBeanEL.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Named
public class OpenidConfigBeanEL {

    @Inject
    HttpServletRequest request;

    @Inject
    Config config;

    private static final String BASE_OPENID_KEY = "payara.security.openid";

    public String getTokenEndpointURL() {
        String tenant = getTenant(request);  // a custom method to decide which tenant to use
        return config
                .getOptionalValue(BASE_OPENID_KEY + "." + tenant + ".providerURI", String.class)
                // e.g. payara.security.openid.tenant1.providerURI for "tenant1" tenant
                .orElseGet(() -&gt; {
                    // read config for the "tenant1" tenant by default
                   return config.getValue(BASE_OPENID_KEY + ".tenant1.providerURI", String.class);
                });
    }

    private String getTenant(HttpServletRequest request) {
        return request.getParameter("tenant"); // resolves the tenant name from a query parameter
    }

}</code></pre>
</div>
</div>
</li>
<li>
<p>Finally, configure the OpenID Connector using the <code>OpenIdAuthenticationDefinition</code> annotation that references the <code>getTokenEndpointURL()</code> in an EL expression:</p>
<div class="listingblock">
<div class="title">SecurityBean.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@OpenIdAuthenticationDefinition(
        providerURI = "#{openidConfigBean.tokenEndpointURL}",
        clientId = CLIENT_ID_VALUE,
        clientSecret = CLIENT_SECRET_VALUE,
        redirectURI = "${baseURL}/Callback"
)
public class SecurityBean {
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="logout"><a class="anchor" href="#logout"></a>Logout functionality</h3>
<div class="paragraph">
<p>With the <code>logout</code> parameter of the <code>OpenIdAuthenticationDefinition</code> you can define the behavior when the user logs out of the application and defines how the RP session is managed.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Configuration Options</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">MP Config property</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>notifyProvider</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">payara.security.openid.provider.notify.logout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Notify the OIDC provider (OP) that the user has logged out of
    the application and might want to log out of the OP as well. If true then
    after having logged out the user from RP, redirects the End-User&#8217;s User
    Agent to the OP&#8217;s logout endpoint URL. This URL is normally obtained via
    the <code>end_session_endpoint</code> element of the OP&#8217;s metadata or can be
    customized via <code>fish.payara.security.annotations.OpenIdProviderMetadata#endSessionEndpoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>redirectURI</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">payara.security.openid.logout.redirectURI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The post logout redirect URI to which the RP is requesting that
   the End-User&#8217;s User Agent be redirected after a logout has been
   performed. If redirect URI is empty then redirect to OpenID connect
  provider <em>authorization_endpoint</em> for re-authentication.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>accessTokenExpiry</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">payara.security.openid.logout.access.token.expiry</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the application session times out when the Access Token expires.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>identityTokenExpiry</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">payara.security.openid.logout.identity.token.expiry</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the application session times out when the Identity Token expires.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A programmatic logout is performed by calling <code>OpenIdContext#logout()</code> which invalidates the RP&#8217;s active OpenId Connect session. If <code>fish.payara.security.annotations.LogoutDefinition#notifyProvider</code> is set to true then it redirects the End-User&#8217;s User Agent to the <code>end_session_endpoint</code> to notify the OP that the user has logged out of the RP&#8217;s application. It will also ask the user whether they want to logout from the OP as well. After successful logout, the End-User&#8217;s User Agent redirects back to the RP&#8217;s <code><em>post_redirect_uri</em></code> configured via the <code>fish.payara.security.annotations.LogoutDefinition#redirectURI</code> property.</p>
</div>
</div>
<div class="sect2">
<h3 id="provider-metadata"><a class="anchor" href="#provider-metadata"></a>Provider Metadata</h3>
<div class="paragraph">
<p>If the OpenId server doesn&#8217;t provide autoconfiguration or it is necessary to customize it, it is possible to set these values in the <code>providerMetadata</code> attribute of the <code>@OpenIdAuthenticationDefinition</code> annotation. It&#8217;s also possible to specify all values by using MicroProfile Config properties. None of the attributes are required in the annotation, but some options are required and must be specified either in the annotation or a MicroProfile property or must be provided by the OIDC provider. The order of evaluation is: MicroProfile Config -&#8594;  <code>@OpenIdProviderMetadata</code> -&#8594; automatic configuration on <code>providerURI</code> address.</p>
</div>
<div class="paragraph">
<p>When these values, which correspond to lists (e.g. <code>scopesSupported</code>, <code>responseTypesSupported</code>), are loaded from MicroProfile Config, they are separated by a comma, following <a href="https://download.eclipse.org/microprofile/microprofile-config-2.0/microprofile-config-spec-2.0.html#_array_converters">MicroProfile Config Array conventions</a>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Provider Metadata Options</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">MP Config property</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>issuer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.provider.issuer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The base address of OpenId Connect Provider (OIDC Provider).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>authorizationEndpoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.provider.authorizationEndpoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The URL for the OAuth2 provider to provide authentication.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tokenEndpoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.provider.tokenEndpoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The URL for the OAuth2 provider to give the authorization token.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>userinfoEndpoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.provider.userinfoEndpoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An OAuth 2.0 Protected Resource that returns Claims about the authenticated End-User.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>endSessionEndpoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.provider.endSessionEndpoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OIDC Provider&#8217;s endpoint to notify that the End-User has logged out of the site and might want to log out of the OIDC Provider as well.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jwksURI</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.provider.jwksURI</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An OIDC Provider&#8217;s JSON Web Key Set document.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>scopesSupported</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.provider.scopesSupported</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">recommended</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of the OAuth 2.0 scope values that this server supports, e.g. <code>openid</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>responseTypesSupported</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.provider.responseTypeSupported</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of the OAuth 2.0 response_type values that this OIDC Provider supports, e.g. <code>code</code>, <code>id_token</code>, <code>token id_token</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>subjectTypesSupported</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.provider.subjectTypesSupported</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of the Subject Identifier types that this OIDC Provider supports. Valid types include <code>pairwise</code> and <code>public</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>idTokenSigningAlgValuesSupported</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.provider.idTokenSigningAlgorithmsSupported</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of the JWS signing algorithms (algorithm values) supported by the OIDC Provider for the ID Token to encode the Claims in a JWT, e.g. <code>RS256</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>idTokenEncryptionAlgValuesSupported</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.provider.idTokenEncryptionAlgValuesSupported</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of the JWE encryption algorithms (<code>alg</code> values) supported by the OIDC Provider for the ID Token to encode the Claims in a JWT.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>idTokenEncryptionEncValuesSupported</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.provider.idTokenEncryptionEncValuesSupported</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of the JWE encryption algorithms (<code>enc</code> values) supported by the OIDC Provider for the ID Token to encode the Claims in a JWT.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>claimsSupported</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.provider.claimsSupported</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">recommended</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of the Claim Names of the Claims that the OIDC Provider MAY be able to supply values for. Note that for privacy or other reasons, this might not be an exhaustive list.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="secret-alias"><a class="anchor" href="#secret-alias"></a>Client Secret Aliasing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The client secret can be input directly, or for added security it can be aliased using any of the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#/documentation/payara-server/password-aliases/Overview.adoc" class="page unresolved">Password Aliases</a></p>
</li>
<li>
<p><a href="#/documentation/payara-server/server-configuration/var-substitution/Overview.adoc" class="page unresolved">Environment Variables / System Properties</a></p>
</li>
<li>
<p><a href="#/documentation/microprofile/config/Overview.adoc" class="page unresolved">Config API</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fetch-caller-data"><a class="anchor" href="#fetch-caller-data"></a>Fetch Caller Data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As the OpenId Connect Client is built on top of Jakarta EE Security API, therefore <code>javax.security.enterprise.SecurityContext</code> interface can provide caller info which is available as a CDI bean and can be injected into any context-aware instance.</p>
</div>
<div class="paragraph">
<p>The Payara Public API also provides a <code>fish.payara.security.openid.api.OpenIdContext</code> interface which is also available as a CDI bean and consist of the following methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>getCallerName()</code> method - Gets the caller name of the currently authenticated user.</p>
</li>
<li>
<p>The <code>getCallerGroups()</code> method - Gets the groups associated with the caller.</p>
</li>
<li>
<p>The <code>getSubject()</code> method - Subject Identifier. A locally unique and never reassigned identifier within the Issuer for the End-User, which is intended to be consumed by the Client.</p>
</li>
<li>
<p>The <code>getTokenType()</code> method - Gets the token type value. The value MUST be <code>Bearer</code> or another token type value that the client has negotiated with the authorization server.</p>
</li>
<li>
<p>The <code>getAccessToken()</code> method - Gets the authorization token that was received from the OpenId Connect provider.</p>
</li>
<li>
<p>The <code>getIdentityToken()</code> method - Gets the identity token that was received from the OpenId Connect provider.</p>
</li>
<li>
<p>The <code>getRefreshToken()</code> method - Returns the refresh token that is used by OIDC client to get a new access token.</p>
</li>
<li>
<p>The <code>getExpiresIn()</code> method - Return the time that the access token is granted for, if it is set to expire.</p>
</li>
<li>
<p>The <code>getClaimsJson()</code> method - Gets the User Claims JSON that was received from the <code>userinfo</code> endpoint.</p>
</li>
<li>
<p>The <code>getClaims()</code> method - Gets the User Claims that were received from the <code>userinfo</code> endpoint.</p>
</li>
<li>
<p>The <code>getProviderMetadata()</code> method - The OpenId Connect Provider&#8217;s metadata document fetched via provider URI.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="user-information-from-the-id-token"><a class="anchor" href="#user-information-from-the-id-token"></a>User Information from the ID Token</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>userClaimsFromIDToken</code> attribute that belongs to the <code>@OpenIdAuthenticationDefinition</code> will instruct the container to retrieve the user information details from the ID Token instead of calling the <code>userinfo</code> endpoint, as defined by the OpenID Connect standard workflow. As such, this behaviour is non-standard and should be used on special cases.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To properly connect an application with Microsoft ADFS this property is required because by default Microsoft ADFS doesn&#8217;t allow calls to the <code>userinfo</code> endpoint.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Configuration Option</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">MP Config Property Name</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>userClaimsFromIDToken</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payara.security.openid.userClaimsFromIDToken</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instructs the container to retrieve user information from the ID Token</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<div class="sect2">
<h3 id="user-information-from-the-id-token-example"><a class="anchor" href="#user-information-from-the-id-token-example"></a>Example</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@OpenIdAuthenticationDefinition(
       providerURI = "https://sample-openid-server.com",
       clientId = "87068hgfg5675htfv6mrucov57bknst.apps.sample.com",
       clientSecret = "{my-secret}",
       redirectURI = "${baseURL}/callback",
       userClaimsFromIDToken=true
)
public class SecurityBean {

}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="disable-scope-validation"><a class="anchor" href="#disable-scope-validation"></a>Disable Scope Validation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default, the OpenID Connect connector validates that a scope is reported as a supported scope by the provider. However, some providers support more scopes than they actually report as supported scopes. In order to disable the validation and allow using such scopes, it&#8217;s possible to use the <code>disableScopeValidation</code> property of <code>OpenIdProviderMetadata</code>. See the <a href="#configuration">Configuration</a> section for more details about this option.</p>
</div>
<div class="sect2">
<h3 id="disable-scope-validation-example"><a class="anchor" href="#disable-scope-validation-example"></a>Example</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@OpenIdAuthenticationDefinition(
       providerURI = "https://sample-openid-server.com",
       clientId = "87068hgfg5675htfv6mrucov57bknst.apps.sample.com",
       clientSecret = "{my-secret}",
       redirectURI = "${baseURL}/callback",
       providerMetadata = @OpenIdProviderMetadata(disableScopeValidation = true))
public class SecurityBean {

}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="bearer-auth"><a class="anchor" href="#bearer-auth"></a>Bearer Authentication and Authorization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to authenticate and authorize calls between services using the OpenID mechanism, it is possible to use authorization compatible with <a href="https://datatracker.ietf.org/doc/html/rfc6750">RFC 6750</a>. In this case, the access token presented to the resource service is an JWT token that is used to verify that the caller has access to OAuth2 protected resources.</p>
</div>
<div class="sect2">
<h3 id="obtaining-token"><a class="anchor" href="#obtaining-token"></a>Obtaining JWT Token</h3>
<div class="paragraph">
<p>Obtaining the token is specific to the OAuth provider and the application. The usual approach is using <a href="https://datatracker.ietf.org/doc/html/rfc6749#section-4.4">Client Credentials Grant</a>, where an application posts its clientId and secret to identity provider and receives access and refresh tokens in return.</p>
</div>
</div>
<div class="sect2">
<h3 id="passing-token"><a class="anchor" href="#passing-token"></a>Passing Token To The Resource Service</h3>
<div class="paragraph">
<p>The obtained access token is passed with every request to the resource service by adding it into the <code>Authorization</code> HTTP header:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Authorization: Bearer access__token</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="processing-token"><a class="anchor" href="#processing-token"></a>Processing Bearer Authorization</h3>
<div class="paragraph">
<p>When the <code>Bearer</code> authorization header is present in the request, the provided token is verified. It&#8217;s validated that it comes from the expected issuer and hasn&#8217;t expired.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Compared to the normal browser flow, no groups are automatically assigned to the identity. The reason for this is that machine-to-machine communication tends to be much more fine-grained and services might want to check more claims, such as <code>audience</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The resource service is required to map the information in the JWT token to groups utilizing the <code><a href="https://jakarta.ee/specifications/platform/8/apidocs/javax/security/enterprise/identitystore/identitystore">IdentityStore</a></code> interface. The OpenID connector provides the following classes to make this process possible:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>AccessTokenCallerPrincipal</code></dt>
<dd>
<p>Caller principal subclass that contains access to all claims of passed JWT token</p>
</dd>
<dt class="hdlist1"><code>BearerGroupIdentityStore</code></dt>
<dd>
<p>A convenience base implementation of the necessary Jakarta EE security identity store.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
@DeclareRoles({"user", "calendar-reader"})
public class Auth0BearerIdentityStore extends BearerGroupsIdentityStore {

    @Override
    protected Set&lt;String&gt; getCallerGroups(AccessTokenCallerPrincipal callerPrincipal) {
        if (callerPrincipal.hasAudience("https://example.org/api/user")) {
            // if the token is for USER api, set this group
            return Set.of("user");
        }
        if (callerPrincipal.hasAudience("https://example.org/api/delegate")
                // delegate API is further constrained by scope
                &amp;&amp; callerPrincipal.getAccessToken().getScope().contains("read:calendar")) {
            return Set.of("calendar-reader");
        }
        return Set.of();
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The Payara Platform also provides similar functionality by way of the MicroProfile JWT Authentication specification, which is limited only to securing JAX-RS resources. On the other hand, the OpenID Connect Bearer Authentication and Authorization feature is better aligned with the OpenID Connect support in Payara Platform and can also be used to secure other web resources like Jakarta Servlets, for example.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="specific-providers"><a class="anchor" href="#specific-providers"></a>Integration with Specific Providers</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="google-oidc-integration"><a class="anchor" href="#google-oidc-integration"></a>Google Integration</h3>
<div class="paragraph">
<p>The Payara Public API provides built-in support for Google OpenID Provider via the <code>@GoogleAuthenticationDefinition</code> annotation.</p>
</div>
<div class="sect3">
<h4 id="google-refresh-token"><a class="anchor" href="#google-refresh-token"></a>Request Refresh Token</h4>
<div class="paragraph">
<p>To enable the refresh token feature, set the <code>tokenAutoRefresh</code> to true and add the <code>access_type</code> parameter value to <code>offline</code> so that application can refresh access tokens when the user is not present at the browser.</p>
</div>
<div class="paragraph">
<p>If application requests <code>offline</code> access then the application can receive access and refresh token. Once the application has a refresh token, it can obtain a new access token at any time or as older ones expire. Otherwise, If application requests <code>online</code> access, your application will only receive an access token</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@GoogleAuthenticationDefinition(
    providerURI="#{openidConfigBean.tokenEndpointURL}",
    clientId="#{openidConfigBean.clientId}",
    clientSecret="#{openidConfigBean.clientSecret}",
    ...
    tokenAutoRefresh = true,
    extraParameters = {"access_type=offline", "approval_prompt=force"}
)
public class SecurityBean {
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="azure-ad-oidc-integration"><a class="anchor" href="#azure-ad-oidc-integration"></a>Azure AD Integration</h3>
<div class="paragraph">
<p>The Payara Public API also provides built-in support for Azure AD OpenID Provider via the <code>@AzureAuthenticationDefinition</code> annotation.</p>
</div>
<div class="sect3">
<h4 id="azure-token"><a class="anchor" href="#azure-token"></a>Request Refresh Token</h4>
<div class="paragraph">
<p>To receive the refresh token, set the <code>tokenAutoRefresh</code> to true and explicitly add the <code>offline_access</code> scope to the definition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@AzureAuthenticationDefinition(
    providerURI="#{openidConfigBean.tokenEndpointURL}",
    clientId="#{openidConfigBean.clientId}",
    clientSecret="#{openidConfigBean.clientSecret}",
    ...
    tokenAutoRefresh = true,
    scope = {OPENID_SCOPE, EMAIL_SCOPE, PROFILE_SCOPE, OFFLINE_ACCESS_SCOPE}
)
public class SecurityBean {
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="azure-groups"><a class="anchor" href="#azure-groups"></a>Groups Mapping</h4>
<div class="ulist">
<ul>
<li>
<p>To add the groups to the registered application, Sign in to the Azure portal &gt; Azure Active Directory &gt; Manage &gt; App registrations &gt; select your application:
<span class="image"><img src="../../_images/security-connector/oidc/azure/app_registrations.png" alt="Select application"></span></p>
</li>
<li>
<p>You may also add the custom roles via <strong>Roles and administrators</strong> under the <strong>Manage</strong> section:
<span class="image"><img src="../../_images/security-connector/oidc/azure/custom_role.png" alt="Add Custom Roles"></span></p>
</li>
<li>
<p>Now to map group claims, select <strong>Token configuration</strong> under the <strong>Manage</strong> section:
<span class="image"><img src="../../_images/security-connector/oidc/azure/token_configuration.png" alt="Token configuration"></span></p>
</li>
<li>
<p>Press <strong>Add groups claim</strong> button to select group types and customize Id and/or Access token properties:
<span class="image"><img src="../../_images/security-connector/oidc/azure/add_groups_claim.png" alt="Add Groups Claim"></span></p>
</li>
<li>
<p>Groups claim can also be defined via Azure <strong>Manifest</strong> under the <strong>Manage</strong> section which is a JSON configuration file.</p>
</li>
<li>
<p>To retrieve and map the caller name &amp; groups from token claims, set the caller name &amp; group claim definition to <code>preferred_username</code> &amp; <code>groups</code>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>@AzureAuthenticationDefinition(
    providerURI="#{openidConfigBean.tokenEndpointURL}",
    clientId="#{openidConfigBean.clientId}",
    clientSecret="#{openidConfigBean.clientSecret}",
    ...
    claimsDefinition = @ClaimsDefinition(
            callerGroupsClaim = "groups",
            callerNameClaim = "preferred_username"
    )
)
public class SecurityBean {
}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="microsoft-adfs-integration"><a class="anchor" href="#microsoft-adfs-integration"></a>Microsoft ADFS Integration</h4>
<div class="paragraph">
<p>To enable integration for Microsoft ADFS it is needed to use the <code>userClaimsFromIDToken</code> annotation attribute. See <a href="#user-information-from-the-id-token">User Information from the ID Token</a> for more information.</p>
</div>
</div>
<div class="sect3">
<h4 id="azure-ad-scope-validation"><a class="anchor" href="#azure-ad-scope-validation"></a>Azure AD Scope Validation</h4>
<div class="paragraph">
<p>To disable the scope validation for Azure AD integration it is needed to use the <code>disableScopeValidation</code> annotation attribute. See <a href="#disable-scope-validation">Disable Scope Validation</a> for more information.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="keycloak-oidc-integration"><a class="anchor" href="#keycloak-oidc-integration"></a>Keycloak Integration</h3>
<div class="paragraph">
<p>Keycloak is an Open Source Identity and Access Management Server, which is a OAuth2 and OpenID Connect(OIDC) protocol complaint. In this section,the basic steps are described to setup Keycloak OpenId provider.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Refer to Keycloak <a href="https://www.keycloak.org/docs/latest/getting_started/index.html">getting started documentation</a> to run and setup keycloak.</p>
</li>
<li>
<p>After Keycloak setup done, login to Keycloak admin console and add the new realm by pressing the <strong>Add Realm</strong> button: <span class="image"><img src="../../_images/security-connector/oidc/keycloak/add-realm.png" alt="Add Realm"></span></p>
</li>
<li>
<p>Copy the OpenId endpoint configuration URL from endpoint section:
<span class="image"><img src="../../_images/security-connector/oidc/keycloak/realm-endpoint.png" alt="Realm Endpoint"></span></p>
</li>
<li>
<p>Now add the <strong>Role</strong> that will be used by the application to define which users will be authorized to access the application.
<span class="image"><img src="../../_images/security-connector/oidc/keycloak/add-role.png" alt="Add role"></span></p>
</li>
<li>
<p>Create the <strong>Groups</strong>:
<span class="image"><img src="../../_images/security-connector/oidc/keycloak/create-group.png" alt="Create Groups"></span></p>
</li>
<li>
<p>Add the <strong>User</strong>:
<span class="image"><img src="../../_images/security-connector/oidc/keycloak/add-user.png" alt="Add User"></span></p>
</li>
<li>
<p>After the user is created, set a new <strong>password</strong> for the user:
<span class="image"><img src="../../_images/security-connector/oidc/keycloak/set-user-password.png" alt="Set Password"></span></p>
</li>
<li>
<p>Now map the user to roles. Click on <strong>Role Mappings</strong> tab and assign the roles to the user from the available roles:
<span class="image"><img src="../../_images/security-connector/oidc/keycloak/user-role-mapping.png" alt="User Role Mapping"></span></p>
</li>
<li>
<p>Assign the user to the groups. Click on <strong>Groups</strong> tab and join the groups from the available groups:
<span class="image"><img src="../../_images/security-connector/oidc/keycloak/join-group.png" alt="Join Groups"></span></p>
</li>
<li>
<p>Create the OpenId Client by clicking the <strong>Client</strong> option from sidebar and press the <strong>create</strong> button:
<span class="image"><img src="../../_images/security-connector/oidc/keycloak/create-client.png" alt="Create OpenID Client"></span></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Enter the Client ID and select the Client Protocol <strong>openid-connect</strong> and press <strong>Save</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>After the OpenId client is created change its <strong>Access Type</strong> to <strong>confidential</strong> and enter the valid <strong>Redirect URIs</strong>:
<span class="image"><img src="../../_images/security-connector/oidc/keycloak/client-access-type-confidentail.png" alt="Access Type"></span></p>
</li>
<li>
<p>Next copy the client <strong>secret</strong> from <strong>Credentials</strong> tab.
<span class="image"><img src="../../_images/security-connector/oidc/keycloak/client-secret.png" alt="Client Secret"></span></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here&#8217;s an example that configures a OpenID Connect client for Keycloak provider. To test the KeyCloak OpenId provider, enter the copied client secret, client ID (client name) and the endpoint configuration URL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@OpenIdAuthenticationDefinition(
    providerURI = "http://${keycloak-host}:${keycloak-port}/auth/realms/test-realm",
    clientId = "test-client",
    clientSecret = "1f6744ae-d7e7-4876-bc44-78fb691316a1"
    ...
)
public class SecurityBean {
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="keycloak-groups"><a class="anchor" href="#keycloak-groups"></a>Groups Mapping</h4>
<div class="ulist">
<ul>
<li>
<p>To get the groups details in token claims, navigate to KeyCloak admin console &gt; OpenId <strong>Client</strong> &gt; <strong>Mappers</strong> tab &gt; press <strong>create</strong> button &gt; Select <strong>Group Membership</strong> mapper type &gt; enter the <strong>Name</strong> and <strong>Token Claim Name</strong> &gt; press <strong>Save</strong>.
<span class="image"><img src="../../_images/security-connector/oidc/keycloak/groups-claim.png" alt="Groups Claim"></span></p>
</li>
<li>
<p>To retrieve and map the caller name &amp; groups from token claims, set the caller name &amp; group claim definition to <code>preferred_username</code> &amp; <code>groups</code>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>@OpenIdAuthenticationDefinition(
    providerURI = "http://${keycloak-host}:${keycloak-port}/auth/realms/test-realm",
    clientId = "test-client",
    clientSecret = "1f6744ae-d7e7-4876-bc44-78fb691316a1"
    ...
    claimsDefinition = @ClaimsDefinition(
            callerGroupsClaim = "groups",
            callerNameClaim = "preferred_username"
    )
)
public class SecurityBean {
}</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="see-also"><a class="anchor" href="#see-also"></a>See Also</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="http://openid.net/specs/openid-connect-core-1_0.html">OpenID Connect Core</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/documentation.html">KeyCloak Documentation</a></p>
</li>
<li>
<p><a href="https://jakarta.ee/specifications/security/">Jakarta Security API</a></p>
</li>
<li>
<p><a href="../MicroProfile/jwt.html" class="page">MicroProfile JWT Authentication API</a></p>
</li>
</ul>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script async src="../../../../_/js/vendor/docSearch.js"></script>
  </body>
</html>
